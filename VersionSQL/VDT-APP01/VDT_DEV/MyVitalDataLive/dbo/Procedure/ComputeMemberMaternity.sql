/****** Object:  Procedure [dbo].[ComputeMemberMaternity]    Committed by VersionSQL https://www.versionsql.com ******/

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- 2021-07-27 | TFS 5792 | Added merge for various comorbidities and computed a maternity risk score; change lookback from 9 months to 120 days
-- =============================================
CREATE PROCEDURE [dbo].[ComputeMemberMaternity] 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	truncate table [dbo].[ComputedMemberMaternity] 

	insert into [dbo].[ComputedMemberMaternity]
	(MVDID, IsPregnant, PregnantDate)
SELECT DISTINCT h.[MVDID], 1, max(H.StatementFromDate)
FROM [MyVitalDataLive].[dbo].[FinalClaimsHeaderCode] Dx
join [dbo].[FinalClaimsHeader] H on H.MVDID = Dx.MVDID and H.ClaimNumber = Dx.ClaimNumber
where
DATEDIFF(DAY,H.StatementFromDate,GetDate()) <= 120 and
((CodeType='PROC'and
CodeValue in(
'76801',
'76802',
'76803',
'76804',
'76805',
'76806',
'76807',
'76808',
'76809',
'76810',
'76811',
'76812',
'76813',
'76814',
'76815',
'76816',
'76817',
'80055'
)
)or
(CodeType='DIAG'and ICDVersion='0'
and CodeValue in
(
'O0900',
'O0901',
'O0902',
'O0903',
'O0910',
'O0911',
'O0912',
'O0913',
'O09211',
'O09212',
'O09213',
'O09219',
'O09291',
'O09292',
'O09293',
'O09299',
'O0930',
'O0931',
'O0932',
'O0933',
'O0940',
'O0941',
'O0942',
'O0943',
'O0970',
'O0971',
'O0972',
'O0973',
'O09811',
'O09812',
'O09813',
'O09819',
'O09821',
'O09822',
'O09823',
'O09829',
'O0990',
'O0991',
'O0992',
'O0993',
'O10011',
'O10012',
'O10013',
'O10019',
'O10111',
'O10112',
'O10113',
'O10119',
'O10211',
'O10212',
'O10213',
'O10219',
'O10311',
'O10312',
'O10313',
'O10319',
'O10411',
'O10412',
'O10413',
'O10419',
'O10911',
'O10912',
'O10913',
'O10919',
'O111',
'O112',
'O113',
'O119',
'O1200',
'O1201',
'O1202',
'O1203',
'O1210',
'O1211',
'O1212',
'O1213',
'O1220',
'O1221',
'O1222',
'O1223',
'O131',
'O132',
'O133',
'O139',
'O1400',
'O1402',
'O1403',
'O1410',
'O1412',
'O1413',
'O1420',
'O1422',
'O1423',
'O1490',
'O1492',
'O1493',
'O1500',
'O1502',
'O1503',
'O159',
'O161',
'O162',
'O163',
'O169',
'O200',
'O208',
'O209',
'O210',
'O211',
'O212',
'O218',
'O219',
'O2200',
'O2201',
'O2202',
'O2203',
'O2210',
'O2211',
'O2212',
'O2213',
'O2220',
'O2221',
'O2222',
'O2223',
'O2230',
'O2231',
'O2232',
'O2233',
'O2240',
'O2241',
'O2242',
'O2243',
'O2250',
'O2251',
'O2252',
'O2253',
'O228X1',
'O228X2',
'O228X3',
'O228X9',
'O2290',
'O2291',
'O2292',
'O2293',
'O2300',
'O2301',
'O2302',
'O2303',
'O2310',
'O2311',
'O2312',
'O2313',
'O2320',
'O2321',
'O2322',
'O2323',
'O2330',
'O2331',
'O2332',
'O2333',
'O2340',
'O2341',
'O2342',
'O2343',
'O23511',
'O23512',
'O23513',
'O23519',
'O23521',
'O23522',
'O23523',
'O23529',
'O23591',
'O23592',
'O23593',
'O23599',
'O2390',
'O2391',
'O2392',
'O2393',
'O24011',
'O24012',
'O24013',
'O24019',
'O24111',
'O24112',
'O24113',
'O24119',
'O24311',
'O24312',
'O24313',
'O24319',
'O24410',
'O24414',
'O24419',
'O24811',
'O24812',
'O24813',
'O24819',
'O24911',
'O24912',
'O24913',
'O24919',
'O2510',
'O2511',
'O2512',
'O2513',
'O2600',
'O2601',
'O2602',
'O2603',
'O2610',
'O2611',
'O2612',
'O2613',
'O2620',
'O2621',
'O2622',
'O2623',
'O2630',
'O2631',
'O2632',
'O2633',
'O2640',
'O2641',
'O2642',
'O2643',
'O26611',
'O26612',
'O26613',
'O26619',
'O26711',
'O26712',
'O26713',
'O26719',
'O26811',
'O26812',
'O26813',
'O26819',
'O26821',
'O26822',
'O26823',
'O26829',
'O26831',
'O26832',
'O26833',
'O26839',
'O26841',
'O26842',
'O26843',
'O26849',
'O26851',
'O26852',
'O26853',
'O26859',
'O2686',
'O26872',
'O26873',
'O26879',
'O26891',
'O26892',
'O26893',
'O26899',
'O2690',
'O2691',
'O2692',
'O2693',
'O29011',
'O29012',
'O29013',
'O29019',
'O29021',
'O29022',
'O29023',
'O29029',
'O29091',
'O29092',
'O29093',
'O29099',
'O29111',
'O29112',
'O29113',
'O29119',
'O29121',
'O29122',
'O29123',
'O29129',
'O29191',
'O29192',
'O29193',
'O29199',
'O29211',
'O29212',
'O29213',
'O29219',
'O29291',
'O29292',
'O29293',
'O29299',
'O293X1',
'O293X2',
'O293X3',
'O293X9',
'O2940',
'O2941',
'O2942',
'O2943',
'O295X1',
'O295X2',
'O295X3',
'O295X9',
'O2960',
'O2961',
'O2962',
'O2963',
'O298X1',
'O298X2',
'O298X3',
'O298X9',
'O2990',
'O2991',
'O2992',
'O2993',
'O30001',
'O30002',
'O30003',
'O30009',
'O30011',
'O30012',
'O30013',
'O30019',
'O30021',
'O30022',
'O30023',
'O30029',
'O30031',
'O30032',
'O30033',
'O30039',
'O30041',
'O30042',
'O30043',
'O30049',
'O30091',
'O30092',
'O30093',
'O30099',
'O30101',
'O30102',
'O30103',
'O30109',
'O30111',
'O30112',
'O30113',
'O30119',
'O30121',
'O30122',
'O30123',
'O30129',
'O30191',
'O30192',
'O30193',
'O30199',
'O30201',
'O30202',
'O30203',
'O30209',
'O30211',
'O30212',
'O30213',
'O30219',
'O30221',
'O30222',
'O30223',
'O30229',
'O30291',
'O30292',
'O30293',
'O30299',
'O3100X0',
'O3100X1',
'O3100X2',
'O3100X3',
'O3100X4',
'O3100X5',
'O3100X9',
'O3101X0',
'O3101X1',
'O3101X2',
'O3101X3',
'O3101X4',
'O3101X5',
'O3101X9',
'O3102X0',
'O3102X1',
'O3102X2',
'O3102X3',
'O3102X4',
'O3102X5',
'O3102X9',
'O3103X0',
'O3103X1',
'O3103X2',
'O3103X3',
'O3103X4',
'O3103X5',
'O3103X9',
'O3110X0',
'O3110X1',
'O3110X2',
'O3110X3',
'O3110X4',
'O3110X5',
'O3110X9',
'O3111X0',
'O3111X1',
'O3111X2',
'O3111X3',
'O3111X4',
'O3111X5',
'O3111X9',
'O3112X0',
'O3112X1',
'O3112X2',
'O3112X3',
'O3112X4',
'O3112X5',
'O3112X9',
'O3113X0',
'O3113X1',
'O3113X2',
'O3113X3',
'O3113X4',
'O3113X5',
'O3113X9',
'O3120X0',
'O3120X1',
'O3120X2',
'O3120X3',
'O3120X4',
'O3120X5',
'O3120X9',
'O3121X0',
'O3121X1',
'O3121X2',
'O3121X3',
'O3121X4',
'O3121X5',
'O3121X9',
'O3122X0',
'O3122X1',
'O3122X2',
'O3122X3',
'O3122X4',
'O3122X5',
'O3122X9',
'O3123X0',
'O3123X1',
'O3123X2',
'O3123X3',
'O3123X4',
'O3123X5',
'O3123X9',
'O3130X0',
'O3130X1',
'O3130X2',
'O3130X3',
'O3130X4',
'O3130X5',
'O3130X9',
'O3131X0',
'O3131X1',
'O3131X2',
'O3131X3',
'O3131X4',
'O3131X5',
'O3131X9',
'O3132X0',
'O3132X1',
'O3132X2',
'O3132X3',
'O3132X4',
'O3132X5',
'O3132X9',
'O3133X0',
'O3133X1',
'O3133X2',
'O3133X3',
'O3133X4',
'O3133X5',
'O3133X9',
'O330',
'O3670X0',
'O3670X1',
'O3670X2',
'O3670X3',
'O3670X4',
'O3670X5',
'O3670X9',
'O3671X0',
'O3671X1',
'O3671X2',
'O3671X3',
'O3671X4',
'O3671X5',
'O3671X9',
'O3672X0',
'O3672X1',
'O3672X2',
'O3672X3',
'O3672X4',
'O3672X5',
'O3672X9',
'O3673X0',
'O3673X1',
'O3673X2',
'O3673X3',
'O3673X4',
'O3673X5',
'O3673X9',
'O4400',
'O4401',
'O4402',
'O4403',
'O4410',
'O4411',
'O4412',
'O4413',
'O45001',
'O45002',
'O45003',
'O45009',
'O45011',
'O45012',
'O45013',
'O45019',
'O45021',
'O45022',
'O45023',
'O45029',
'O45091',
'O45092',
'O45093',
'O45099',
'O458X1',
'O458X2',
'O458X3',
'O458X9',
'O4590',
'O4591',
'O4592',
'O4593',
'O46001',
'O46002',
'O46003',
'O46009',
'O46011',
'O46012',
'O46013',
'O46019',
'O46021',
'O46022',
'O46023',
'O46029',
'O46091',
'O46092',
'O46093',
'O46099',
'O468X1',
'O468X2',
'O468X3',
'O468X9',
'O4690',
'O4691',
'O4692',
'O4693',
'O4700',
'O4702',
'O4703',
'O471',
'O479',
'O480',
'O481',
'O6000',
'O6002',
'O6003',
'O6010X0',
'O6010X1',
'O6010X2',
'O6010X3',
'O6010X4',
'O6010X5',
'O6010X9',
--'O6012X0',
--'O6012X1',
--'O6012X2',
--'O6012X3',
--'O6012X4',
--'O6012X5',
--'O6012X9',
--'O6013X0',
--'O6013X1',
--'O6013X2',
--'O6013X3',
--'O6013X4',
--'O6013X5',
--'O6013X9',
--'O6014X0',
--'O6014X1',
--'O6014X2',
--'O6014X3',
--'O6014X4',
--'O6014X5',
--'O6014X9',
--'O670',
--'O678',
--'O679',
'O88011',
'O88012',
'O88013',
'O88019',
'O88111',
'O88112',
'O88113',
'O88119',
'O88211',
'O88212',
'O88213',
'O88219',
'O88311',
'O88312',
'O88313',
'O88319',
'O88811',
'O88812',
'O88813',
'O88819',
'O905',
'O94',
'O98011',
'O98012',
'O98013',
'O98019',
'O98111',
'O98112',
'O98113',
'O98119',
'O98211',
'O98212',
'O98213',
'O98219',
'O98311',
'O98312',
'O98313',
'O98319',
'O98411',
'O98412',
'O98413',
'O98419',
'O98511',
'O98512',
'O98513',
'O98519',
'O98611',
'O98612',
'O98613',
'O98619',
'O98711',
'O98712',
'O98713',
'O98719',
'O98811',
'O98812',
'O98813',
'O98819',
'O98911',
'O98912',
'O98913',
'O98919',
'O99011',
'O99012',
'O99013',
'O99019',
'O99111',
'O99112',
'O99113',
'O99119',
'O99210',
'O99211',
'O99212',
'O99213',
'O99280',
'O99281',
'O99282',
'O99283',
'O99310',
'O99311',
'O99312',
'O99313',
'O99320',
'O99321',
'O99322',
'O99323',
'O99330',
'O99331',
'O99332',
'O99333',
'O99340',
'O99341',
'O99342',
'O99343',
'O99350',
'O99351',
'O99352',
'O99353',
'O99411',
'O99412',
'O99413',
'O99419',
'O99511',
'O99512',
'O99513',
'O99519',
'O99611',
'O99612',
'O99613',
'O99619',
'O99711',
'O99712',
'O99713',
'O99719',
'O99810',
'O99820',
'O99830',
'O99840',
'O99841',
'O99842',
'O99843',
--'O9989',
'O9A111',
'O9A112',
'O9A113',
'O9A119',
'O9A211',
'O9A212',
'O9A213',
'O9A219',
'O9A311',
'O9A312',
'O9A313',
'O9A319',
'O9A411',
'O9A412',
'O9A413',
'O9A419',
'O9A511',
'O9A512',
'O9A513',
'O9A519',
'Z3201',
'Z331',
'Z3400',
'Z3401',
'Z3402',
'Z3403',
'Z3480',
'Z3481',
'Z3482',
'Z3483',
'Z3490',
'Z3491',
'Z3492',
'Z3493',
'Z3A00',
'Z3A01',
'Z3A08',
'Z3A09',
'Z3A10',
'Z3A11',
'Z3A12',
'Z3A13',
'Z3A14',
'Z3A15',
'Z3A16',
'Z3A17',
'Z3A18',
'Z3A19',
'Z3A20',
'Z3A21',
'Z3A22',
'Z3A23',
'Z3A24',
'Z3A25',
'Z3A26',
'Z3A27',
'Z3A28',
'Z3A29',
'Z3A30',
'Z3A31',
'Z3A32',
'Z3A33',
'Z3A34',
'Z3A35',
--'Z8759',
'Z98870'
)))
group by H.MVDID	

update [dbo].[ComputedMemberMaternity]
set PregnantCode = C.CodeValue
from 
	[dbo].[ComputedMemberMaternity] CM
	inner join 
	(
		select CC.MVDID,CC.CodeValue,HH.StatementFromDate as DxDate
		from FinalClaimsHeaderCode cc
		join [dbo].[FinalClaimsHeader] HH on HH.MVDID = CC.MVDID and HH.ClaimNumber = CC.ClaimNumber
	) C on C.MVDID = CM.MVDID and C.DxDate = CM.PregnantDate
where
 IsPregnant = 1

----------------
MERGE INTO [dbo].[ComputedMemberMaternity] A
USING (
SELECT DISTINCT h.[MVDID], 1 as IsMicarriage, max(H.StatementFromDate) as DxDate
FROM [MyVitalDataLive].[dbo].[FinalClaimsHeaderCode] Dx
join [dbo].[FinalClaimsHeader] H on H.MVDID = Dx.MVDID and H.ClaimNumber = Dx.ClaimNumber
where
DATEDIFF(MONTH,H.StatementFromDate,GetDate()) <= 9 and
(CodeType='DIAG' and ICDVersion='0'
and CodeValue in
(
'Z3A37',
'Z3A38',
'Z3A39',
'Z3A4',
'Z3A40',
'Z3A41',
'Z3A42',
'Z3A43'
)) group by H.MVDID) G
on A.MVDID = G.MVDID
WHEN MATCHED THEN
	UPDATE
	SET A.IsLateTerm = 1
WHEN NOT MATCHED THEN
	insert (MVDID, IsLateTerm) values (G.MVDID, 1);

---------------- 
MERGE INTO [dbo].[ComputedMemberMaternity] A
USING (
SELECT DISTINCT h.[MVDID], 1 as IsMicarriage, max(H.StatementFromDate) as DxDate
FROM [MyVitalDataLive].[dbo].[FinalClaimsHeaderCode] Dx
join [dbo].[FinalClaimsHeader] H on H.MVDID = Dx.MVDID and H.ClaimNumber = Dx.ClaimNumber
where
DATEDIFF(MONTH,H.StatementFromDate,GetDate()) <= 9 and
(CodeType='DIAG' and ICDVersion='0'
and CodeValue in
(
'O000',
'O001',
'O002',
'O008',
'O009',
'O021',
'O030',
'O031',
'O032',
'O0330',
'O0331',
'O0332',
'O0333',
'O0334',
'O0335',
'O0336',
'O0337',
'O0338',
'O0339',
'O034',
'O035',
'O036',
'O037',
'O0380',
'O0381',
'O0382',
'O0383',
'O0384',
'O0385',
'O0386',
'O0387',
'O0388',
'O0389',
'O039',
'O045',
'O046',
'O047',
'O0480',
'O0481',
'O0482',
'O0483',
'O0484',
'O0485',
'O0486',
'O0487',
'O0488',
'O0489',
'O070',
'O071',
'O072',
'O0730',
'O0731',
'O0732',
'O0733',
'O0734',
'O0735',
'O0736',
'O0737',
'O0738',
'O0739',
'O074',
'O080',
'O081',
'O082',
'O083',
'O084',
'O085',
'O086',
'O087'
)) group by H.MVDID) G
on A.MVDID = G.MVDID
WHEN MATCHED THEN
	UPDATE
	SET A.IsMiscarriage = 1, A.[MiscarriageDate] = G.DxDate
WHEN NOT MATCHED THEN
	insert (MVDID, IsMiscarriage, [MiscarriageDate]) values (G.MVDID, 1, G.DxDate);

update [dbo].[ComputedMemberMaternity]
set MiscarriageCode = C.CodeValue
from 
	[dbo].[ComputedMemberMaternity] CM
	inner join 
	(
		select CC.MVDID,CC.CodeValue,HH.StatementFromDate as DxDate
		from FinalClaimsHeaderCode cc
		join [dbo].[FinalClaimsHeader] HH on HH.MVDID = CC.MVDID and HH.ClaimNumber = CC.ClaimNumber
	) C on C.MVDID = CM.MVDID and C.DxDate = CM.MiscarriageDate
where
 IsMiscarriage = 1

MERGE INTO [dbo].[ComputedMemberMaternity] A
USING (
SELECT DISTINCT h.[MVDID], 1 as IsDelivered, max(H.StatementFromDate) as DxDate
FROM [MyVitalDataLive].[dbo].[FinalClaimsHeaderCode] Dx
join [dbo].[FinalClaimsHeader] H on H.MVDID = Dx.MVDID and H.ClaimNumber = Dx.ClaimNumber
where
DATEDIFF(MONTH,H.StatementFromDate,GetDate()) <= 12 and
(CodeType='DIAG' and ICDVersion='0'
and CodeValue in
(
'O1002',
'O1003',
'O1012',
'O1013',
'O1022',
'O1032',
'O1042',
'O1043',
'O1092',
'O151',
'O152',
'O2402',
'O2412',
'O2432',
'O24420',
'O24424',
'O24429',
'O2482',
'O2492',
'O2493',
'O252',
'O2662',
'O2672',
'O4200',
'O42011',
'O42012',
'O42013',
'O4202',
'O4210',
'O42111',
'O42112',
'O42113',
'O4212',
'O42911',
'O42912',
'O42913',
'O4292',
--'O6012X0',
--'O6012X1',
--'O6012X2',
--'O6012X3',
--'O6012X4',
--'O6012X5',
--'O6012X9',
--'O6013X0',
--'O6013X1',
--'O6013X2',
--'O6013X3',
--'O6013X4',
--'O6013X5',
--'O6013X9',
--'O6014X0',
--'O6014X1',
--'O6014X2',
--'O6014X3',
--'O6014X4',
--'O6014X5',
--'O6014X9',
'O6020X0',
'O6020X1',
'O6020X2',
'O6020X3',
'O6020X4',
'O6020X5',
'O6020X9',
'O6022X0',
'O6022X1',
'O6022X2',
'O6022X3',
'O6022X4',
'O6022X5',
'O6022X9',
'O6023X0',
'O6023X1',
'O6023X2',
'O6023X3',
'O6023X4',
'O6023X5',
'O6023X9',
'O610',
'O611',
'O618',
'O619',
'O623',
'O628',
'O629',
'O630',
'O631',
'O632',
'O639',
'O640XX0',
'O640XX1',
'O640XX2',
'O640XX3',
'O640XX4',
'O640XX5',
'O640XX9',
'O641XX0',
'O641XX1',
'O641XX2',
'O641XX3',
'O641XX4',
'O641XX5',
'O641XX9',
'O642XX0',
'O642XX1',
'O642XX2',
'O642XX3',
'O642XX4',
'O642XX5',
'O642XX9',
'O643XX0',
'O643XX1',
'O643XX2',
'O643XX3',
'O643XX4',
'O643XX5',
'O643XX9',
'O644XX0',
'O644XX1',
'O644XX2',
'O644XX3',
'O644XX4',
'O644XX5',
'O644XX9',
'O645XX0',
'O645XX1',
'O645XX2',
'O645XX3',
'O645XX4',
'O645XX5',
'O645XX9',
'O648XX0',
'O648XX1',
'O648XX2',
'O648XX3',
'O648XX4',
'O648XX5',
'O648XX9',
'O649XX0',
'O649XX1',
'O649XX2',
'O649XX3',
'O649XX4',
'O649XX5',
'O649XX9',
'O650',
'O651',
'O652',
'O653',
'O654',
'O655',
'O658',
'O659',
'O660',
'O661',
'O662',
'O663',
'O6640',
'O6641',
'O665',
'O666',
'O668',
'O669',
--'O670',
--'O678',
--'O679',
'O68',
'O690XX0',
'O690XX1',
'O690XX2',
'O690XX3',
'O690XX4',
'O690XX5',
'O690XX9',
'O691XX0',
'O691XX1',
'O691XX2',
'O691XX3',
'O691XX4',
'O691XX5',
'O691XX9',
'O692XX0',
'O692XX1',
'O692XX2',
'O692XX3',
'O692XX4',
'O692XX5',
'O692XX9',
'O693XX0',
'O693XX1',
'O693XX2',
'O693XX3',
'O693XX4',
'O693XX5',
'O693XX9',
'O694XX0',
'O694XX1',
'O694XX2',
'O694XX3',
'O694XX4',
'O694XX5',
'O694XX9',
'O695XX0',
'O695XX1',
'O695XX2',
'O695XX3',
'O695XX4',
'O695XX5',
'O695XX9',
'O6981X0',
'O6981X1',
'O6981X2',
'O6981X3',
'O6981X4',
'O6981X5',
'O6981X9',
'O6982X0',
'O6982X1',
'O6982X2',
'O6982X3',
'O6982X4',
'O6982X5',
'O6982X9',
'O6989X0',
'O6989X1',
'O6989X2',
'O6989X3',
'O6989X4',
'O6989X5',
'O6989X9',
'O699XX0',
'O699XX1',
'O699XX2',
'O699XX3',
'O699XX4',
'O699XX5',
'O699XX9',
'O700',
'O701',
'O702',
'O703',
'O704',
'O709',
'O7102',
'O7103',
'O711',
'O712',
'O713',
'O714',
'O715',
'O716',
'O717',
'O7181',
'O7182',
'O7189',
'O719',
'O720',
'O721',
'O722',
'O723',
'O730',
'O731',
'O740',
'O741',
'O742',
'O743',
'O744',
'O745',
'O746',
'O747',
'O748',
'O749',
'O750',
'O751',
'O752',
'O753',
'O754',
'O755',
'O7581',
'O7589',
'O759',
'O76',
'O770',
'O771',
'O778',
'O779',
'O80',
'O82',
'O85',
'O860',
'O8611',
'O8612',
'O8613',
'O8619',
'O8620',
'O8621',
'O8622',
'O8629',
'O864',
'O8681',
'O8689',
'O870',
'O871',
'O872',
'O873',
'O874',
'O878',
'O879',
'O8802',
'O8803',
'O8812',
'O8813',
'O8822',
'O8823',
'O8832',
'O8833',
'O8882',
'O8883',
'O8909',
'O898',
'O899',
'O900',
'O901',
'O902',
'O903',
'O904',
'O9081',
'O9089',
'O909',
'O9102',
'O9112',
'O9122',
'O9220',
'O9229',
'O923',
'O925',
'O9802',
'O9803',
'O9812',
'O9813',
'O9822',
'O9823',
'O9832',
'O9833',
'O9842',
'O9843',
'O9852',
'O9853',
'O9862',
'O9863',
'O9872',
'O9882',
'O9883',
'O9892',
'O9893',
'O9902',
'O9903',
'O9912',
'O9913',
'O99214',
'O99284',
'O99285',
'O99314',
'O99324',
'O99334',
'O99344',
'O99354',
'O99355',
'O9942',
'O9943',
'O9952',
'O9962',
'O9972',
'O99814',
'O99824',
'O99834',
'O99835',
'O99844',
--'O9989',
'O9A12',
'O9A22',
'O9A32',
'O9A42',
'O9A52',
'Z370',
'Z372',
'Z373',
'Z3750',
'Z3751',
'Z3752',
'Z3753',
'Z3754',
'Z3759',
'Z3760',
'Z3761',
'Z3762',
'Z3763',
'Z3764',
'Z3769',
'Z379'
)) group by H.MVDID) G
on A.MVDID = G.MVDID
WHEN MATCHED THEN
	UPDATE
	SET A.IsDelivered = 1, A.[DeliveryDate] = G.DxDate
WHEN NOT MATCHED THEN
	insert (MVDID, IsDelivered, [DeliveryDate]) values (G.MVDID, 1, G.DxDate);

update [dbo].[ComputedMemberMaternity]
set DeliveryCode = C.CodeValue
from 
	[dbo].[ComputedMemberMaternity] CM
	inner join 
	(
		select CC.MVDID,CC.CodeValue,HH.StatementFromDate as DxDate
		from FinalClaimsHeaderCode cc
		join [dbo].[FinalClaimsHeader] HH on HH.MVDID = CC.MVDID and HH.ClaimNumber = CC.ClaimNumber
	) C on C.MVDID = CM.MVDID and C.DxDate = CM.DeliveryDate
where
 IsDelivered = 1

-- Hypertension
MERGE INTO [dbo].[ComputedMemberMaternity] A
USING (
SELECT DISTINCT h.[MVDID], 1 as Hypertension, max(H.StatementFromDate) as DxDate
FROM [MyVitalDataLive].[dbo].[FinalClaimsHeaderCode] Dx
join [dbo].[FinalClaimsHeader] H on H.MVDID = Dx.MVDID and H.ClaimNumber = Dx.ClaimNumber
where
DATEDIFF(MONTH,H.StatementFromDate,GetDate()) <= 12 and
(CodeType='DIAG' and ICDVersion='0'
and CodeValue in
(
'I10',
'I11',
'I12',
'I13',
'I14',
'I15',
'I16'
)) group by H.MVDID) G
on A.MVDID = G.MVDID
WHEN MATCHED THEN
	UPDATE
	SET A.Hypertension = 1;

-- Diabetes
MERGE INTO [dbo].[ComputedMemberMaternity] A
USING (
SELECT DISTINCT h.[MVDID], 1 as Diabetes, max(H.StatementFromDate) as DxDate
FROM [MyVitalDataLive].[dbo].[FinalClaimsHeaderCode] Dx
join [dbo].[FinalClaimsHeader] H on H.MVDID = Dx.MVDID and H.ClaimNumber = Dx.ClaimNumber
where
DATEDIFF(MONTH,H.StatementFromDate,GetDate()) <= 12 and
(CodeType='DIAG' and ICDVersion='0'
and 
	(
		CodeValue like 'E08%' or
		CodeValue like 'E09%' or
		CodeValue like 'E10%' or
		CodeValue like 'E11%' or
		CodeValue like 'E13%'
	)
) group by H.MVDID) G
on A.MVDID = G.MVDID
WHEN MATCHED THEN
	UPDATE
	SET A.Diabetes = 1;

-- SUD
MERGE INTO [dbo].[ComputedMemberMaternity] A
USING (
SELECT DISTINCT h.[MVDID], 1 as SUD, max(H.StatementFromDate) as DxDate
FROM [MyVitalDataLive].[dbo].[FinalClaimsHeaderCode] Dx
join [dbo].[FinalClaimsHeader] H on H.MVDID = Dx.MVDID and H.ClaimNumber = Dx.ClaimNumber
where
DATEDIFF(MONTH,H.StatementFromDate,GetDate()) <= 12 and
(CodeType='DIAG' and ICDVersion='0'
and 
	(
		CodeValue like 'F101%' or -- Alcohol Abuse
		CodeValue like 'F102%' or -- Alcohol dependence
		CodeValue like 'F109%' or -- Alcohol use
		CodeValue like 'F111%' or -- Opioid use
		CodeValue like 'F121%' or -- Cannabis Use
		CodeValue like 'F131%' or -- Sedative, hypnotic or anxiolytic related abuse
		CodeValue like 'F141%' or -- Cocaine abuse
		CodeValue like 'F151%' or -- Other stimulant abuse
		CodeValue like 'F161%' or -- Hallucinogen abuse and dependence
		CodeValue like 'F172%' or -- Nicotine dependence (note: depending on the numbers, we may want this at a lower priority that the other types of abuse and dependence.)
		CodeValue like 'F181%' or -- Inhalant abuse and dependence
		CodeValue like 'F191%' or -- Other psychoactive drug abuse
		CodeValue like 'F55%'     -- Abuse of non-psychoactive substances
	)
) group by H.MVDID) G
on A.MVDID = G.MVDID
WHEN MATCHED THEN
	UPDATE
	SET A.SUD = 1;

-- Depression
MERGE INTO [dbo].[ComputedMemberMaternity] A
USING (
SELECT DISTINCT h.[MVDID], 1 as Depression, max(H.StatementFromDate) as DxDate
FROM [MyVitalDataLive].[dbo].[FinalClaimsHeaderCode] Dx
join [dbo].[FinalClaimsHeader] H on H.MVDID = Dx.MVDID and H.ClaimNumber = Dx.ClaimNumber
where
DATEDIFF(MONTH,H.StatementFromDate,GetDate()) <= 12 and
(CodeType='DIAG' and ICDVersion='0'
and 
	(
		CodeValue like 'F3%' or -- Mood Disorders
		CodeValue like 'F53' or -- Mental and behavioral disorders associated with the puerperium
		CodeValue like 'F1332'  -- Encounter for screening for maternal depression
	)
) group by H.MVDID) G
on A.MVDID = G.MVDID
WHEN MATCHED THEN
	UPDATE
	SET A.Depression = 1;

-- Domestic Abuse
MERGE INTO [dbo].[ComputedMemberMaternity] A
USING (
SELECT DISTINCT h.[MVDID], 1 as DomesticAbuse, max(H.StatementFromDate) as DxDate
FROM [MyVitalDataLive].[dbo].[FinalClaimsHeaderCode] Dx
join [dbo].[FinalClaimsHeader] H on H.MVDID = Dx.MVDID and H.ClaimNumber = Dx.ClaimNumber
where
DATEDIFF(MONTH,H.StatementFromDate,GetDate()) <= 12 and
(CodeType='DIAG' and ICDVersion='0'
and 
	(
		CodeValue like 'Z0441' or -- Encounter for examination following alleged adult rape
		CodeValue like 'Z0442' or -- Encounter for examination and observation following alleged child rape
		CodeValue like 'Z0471' or -- Encounter for examination and observation following alleged adult physical abuse
		CodeValue like 'Z59%'  or -- Homelessness and other problems related to living standards
		CodeValue like 'Z630'  or -- Problems in relationship with spouse or partner
		CodeValue like 'Z6911' or -- Encounter for victim of spousal or partner abuse
		CodeValue like 'Z6912'    -- Encounter for perpetrator of spousal or partner abuse
	)
) group by H.MVDID) G
on A.MVDID = G.MVDID
WHEN MATCHED THEN
	UPDATE
	SET A.DomesticAbuse = 1;

-- Compute Maternity Risk Score
-- 8 = Base Maternity Case Finds + Hypertension (HTN) 
-- 4 = Base Maternity Case Finds + Diabetes
-- 2 = Base Maternity Case Finds + (2 or more of the following conditions - SUD, Depression, Domestic Abuse)
UPDATE [dbo].[ComputedMemberMaternity] 
SET MaternityRiskScore = CASE
	WHEN (Hypertension = 1 and Diabetes = 0 and SUD = 0 and Depression = 0 and DomesticAbuse = 0) THEN 8
	WHEN (Hypertension = 0 and Diabetes = 1 and SUD = 0 and Depression = 0 and DomesticAbuse = 0) THEN 4
	WHEN (Hypertension = 1 and Diabetes = 1 and SUD = 0 and Depression = 0 and DomesticAbuse = 0) THEN 12
	WHEN (Hypertension = 0 and Diabetes = 0 and SUD = 1 and Depression = 1 and DomesticAbuse = 0) THEN 2
	WHEN (Hypertension = 0 and Diabetes = 0 and SUD = 1 and Depression = 0 and DomesticAbuse = 1) THEN 2
	WHEN (Hypertension = 0 and Diabetes = 0 and SUD = 0 and Depression = 1 and DomesticAbuse = 1) THEN 2
	WHEN (Hypertension = 0 and Diabetes = 0 and SUD = 1 and Depression = 1 and DomesticAbuse = 1) THEN 2
	WHEN (Hypertension = 1 and Diabetes = 0 and SUD = 1 and Depression = 1 and DomesticAbuse = 0) THEN 10
	WHEN (Hypertension = 1 and Diabetes = 0 and SUD = 1 and Depression = 0 and DomesticAbuse = 1) THEN 10
	WHEN (Hypertension = 1 and Diabetes = 0 and SUD = 0 and Depression = 1 and DomesticAbuse = 1) THEN 10
	WHEN (Hypertension = 1 and Diabetes = 0 and SUD = 1 and Depression = 1 and DomesticAbuse = 1) THEN 10
	WHEN (Hypertension = 0 and Diabetes = 1 and SUD = 1 and Depression = 1 and DomesticAbuse = 0) THEN 6
	WHEN (Hypertension = 0 and Diabetes = 1 and SUD = 1 and Depression = 0 and DomesticAbuse = 1) THEN 6
	WHEN (Hypertension = 0 and Diabetes = 1 and SUD = 0 and Depression = 1 and DomesticAbuse = 1) THEN 6
	WHEN (Hypertension = 0 and Diabetes = 1 and SUD = 1 and Depression = 1 and DomesticAbuse = 1) THEN 6
	WHEN (Hypertension = 1 and Diabetes = 1 and SUD = 1 and Depression = 1 and DomesticAbuse = 0) THEN 14
	WHEN (Hypertension = 1 and Diabetes = 1 and SUD = 1 and Depression = 0 and DomesticAbuse = 1) THEN 14
	WHEN (Hypertension = 1 and Diabetes = 1 and SUD = 0 and Depression = 1 and DomesticAbuse = 1) THEN 14
	WHEN (Hypertension = 1 and Diabetes = 1 and SUD = 1 and Depression = 1 and DomesticAbuse = 1) THEN 14
	ELSE 0
	END
where 1=1

END